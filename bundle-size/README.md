# Bundle size action

This GitHub Action compares two webpack compilation stats files and comments on PRs with a description of the difference.

## Features

- Compares the build stats of main against build stats of the PR
- Reports the result in markdown tables in a PR comment

## Usage

- Your CI that runs when merging main _must_ create and upload a `main-branch-stats` asset (see [troubleshooting](#troubleshooting) for more info).
- Add a workflow to your Github repository as in the example below.

## Workflow example

```yaml
name: Bundle Stats

on:
  pull_request:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  compare:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - uses: grafana/plugin-actions/bundle-size@main
```

## Options

The following options can be passed to this action:

- `token`: A github token with write access to pull requests and content (defaults to `github.token`).
- `node-version`: The version of node to use (defaults to `20`).
- `threshold`: The minimum entrypoints total percentage difference required to post comments in PRs (defaults to `5`).

## Troubleshooting

**How do I add the `main-branch-stats` asset to my github repo?**

To add and update `main-branch-stats` in your github repo you can make the following changes to your workflow that runs on merges to your default (`main`) branch:

1. Update the build jobs "Build frontend" step inside the `.github/workflows/ci.yml` so on pushes to main the stats.json file is generated by webpack:

```diff
  - name: Build frontend
-   run: npm run build
+   run: |
+     if [ "${{ github.event_name }}" == "push" ] && [ "${{ github.ref }}" == "refs/heads/main" ]; then
+       npm run build -- --profile --json stats.json
+     else
+       npm run build
+     fi

```

1. In the same `github/workflows/ci.yml` workflow build job add an upload stats step after the Build frontend step so the artifact is created:

```yaml
- name: Upload stats.json artifact
  if: github.event_name == 'push' && github.ref == 'refs/heads/main'
  uses: actions/upload-artifact@v4
  with:
    name: main-branch-stats
    path: stats.json
    overwrite: true
```
